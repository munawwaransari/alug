<!DOCTYPE html>
<html lang="en">
<head>
	
	<!-- https://www.cssscript.com/drawing-handwriting-canvas/ -->
	
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="#" />
	<title>Chart Test</title>
	<style>
	#draw-area {
		margin-top: 10px;
		padding: 10px;
		transform-style: preserve-3d;
		box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
		align: center;
	}
	
	#imgDiv{
		padding: 4px;
		position:absolute; 
		top:0;
		left:0;
		display:block;
		width:290px; 
		height:auto;
		align: center;
	}
	
	#textResult{
		padding: 20px;
		font-size: 28px;
		text-align: center;
		width: 100%;
		background-color:#F5F9AA;
		box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
	}
	</style>
	<script src="scripts/jquery/jquery-3.7.1.min.js"></script>
	<script src="scripts/hw-canvas/main.js"></script>
	<script src='https://unpkg.com/tesseract.js@5.0.0/dist/tesseract.min.js'></script>
	<script>
		var canvasElement, canvas, imageUrl;
		
		window.onload = function(){
			canvasElement = document.querySelector('#draw-area');
			canvas = new HandwritingCanvas(canvasElement);
		}
		
		function clearCanvas(){
			if(canvas)
				canvas.clear();
			$("#textResult").empty();
			$("#fileUrl").val('');
			$("#imgDiv").prop('src','');
		}
		
		async function toPNG(){

			if (canvas.isEmpty) {
			  return;
			}
			if(imageUrl)
				URL.revokeObjectURL(imageUrl);			
			
			const blob = await canvas.toBlob('image/png');
			imageUrl = URL.createObjectURL(blob);

			const imgElement = document.createElement('img');
			imgElement.src = imageUrl;
			const createdPngElement = document.querySelector('#result');
			if (createdPngElement.firstChild) {
			  createdPngElement.removeChild(createdPngElement.firstChild);
			}
			createdPngElement.appendChild(imgElement);
		}
		
		async function convert(){
			var url = $("#fileUrl").val().trim();
			if(url === ''){
				canvasToText();
			}else{
				runOCR(url);
			}
		}
		
		async function runOCR(url){
			var output = $("#textResult");
			Tesseract.recognize(
				url, 'ara'
			).then(result => {
				if(result.data)
					output.text(result.data.text);
				else
					output.text('Error!');
			}).catch(err => {
				output.html('<p style="font-size:12px;">Error: '+ err+'</p>');
				console.log(err);
			});
		}
		
		async function canvasToText(url){
			$("#textResult").html('Converting...');
			try{
				const blob = await canvas.toBlob('image/png');
				const reader = new FileReader();
				reader.readAsDataURL(new Blob([blob], { type: 'image/png' })); 
				reader.onloadend = function() {
					runOCR(reader.result);
				}
			}
			catch(err){
				var output = $("#textResult");
				output.html('<p style="font-size:12px;">Error: '+ err+'</p>');
			}
		}
		
		async function saveBlobAsImage() {
			const blob = await canvas.toBlob('image/png');
			const filename = "sample.png";
			const file = new File([blob], filename, { type: blob.type });
			const url = URL.createObjectURL(file);
			const a = document.createElement('a');
			a.href = url;
			a.download = filename;
			
			const div = document.querySelector('#result');
			div.appendChild(a);
			a.click();
			div.removeChild(a);
			URL.revokeObjectURL(url);
		}
		
		function loadImage(){
			const img = document.getElementById('imgDiv');
			img.src = $("#fileUrl").val().trim();
		}
	</script>
</head>
<body>
	<canvas id="draw-area"></canvas>
	<img id="imgDiv" />
	<div id="result"></div>
	<button onclick="clearCanvas()">Clear</button>
	<button onclick="convert()">Convert</button>
	<button onclick="loadImage()">Image</button>
	<div id="textResult"></div>
	<br/>
	Image Path:<br/><textarea id="fileUrl"></textarea>
</body>
</html>